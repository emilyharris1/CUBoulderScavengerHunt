<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>CU Boulder AR Scavenger Hunt</title>

<!-- A-Frame and AR.js (Location-based) -->
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
<!-- Make in-world labels face the camera -->
<script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
<!-- Leaflet for map -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
AFRAME.registerComponent('spin-y', {
schema: {speed: {type: 'number', default: 30}}, // degrees per second
tick: function (time, deltaTime) {
this.el.object3D.rotation.y += (this.data.speed * deltaTime) / 1000;
}
});
</script>

<style>
:root { --bg: rgba(0,0,0,.55); --fg: #fff; --accent: #ffd166; --muted:#d9d9d9; }
html, body { margin:0; padding:0; height:100%; background:#000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
#hud {
position: fixed; inset: 0 0 auto 0; padding: 10px 12px; display:flex; gap:8px;
align-items: flex-start; color: var(--fg); z-index: 9999; pointer-events: none;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
#hud.minimized {
transform: translateY(-50px);
}
#hud .card {
pointer-events: auto;
background: var(--bg); backdrop-filter: blur(6px);
border: 1px solid rgba(255,255,255,.15);
border-radius: 12px; padding: 10px 12px; line-height: 1.25; box-shadow: 0 6px 20px rgba(0,0,0,.25);
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
overflow: hidden;
margin-top: 30px;
}
#hud .title { font-weight: 700; letter-spacing: .2px; }
#hud small { color: var(--muted); }
.row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
label.chk { display:flex; align-items:center; gap:6px; }
.pill {
display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.15);
}
.pill b { color: var(--accent); }
kbd { padding:2px 6px; border-radius:6px; background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.2); }
#toast { position: fixed; inset: auto 0 20px 0; display:flex; justify-content:center; z-index:9999; }
#toast .msg { background: var(--bg); color:var(--fg); border:1px solid rgba(255,255,255,.15); padding:10px 14px; border-radius: 12px; }
.note { font-size: 12px; opacity: .9; }
.btn {
pointer-events:auto; cursor:pointer; user-select:none; -webkit-tap-highlight-color: transparent;
background: rgba(255,255,255,.1); color:#fff; border:1px solid rgba(255,255,255,.2); border-radius: 10px; padding: 6px 10px;
transition: background-color 0.2s ease;
}
.btn:hover { background: rgba(255,255,255,.15); }
.btn:active { background: rgba(255,255,255,.2); }

/* Minimizable content */
.minimizable {
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
transform-origin: top;
opacity: 1;
max-height: 500px;
overflow: hidden;
}
.minimized .minimizable {
opacity: 0;
max-height: 0;
margin-top: 0 !important;
padding-top: 0;
padding-bottom: 0;
}

#toggleHudBtn {
background: rgba(255, 209, 102, 0.15);
color: var(--accent);
border: 1px solid rgba(255, 209, 102, 0.3);
font-weight: 600;
font-size: 14px;
min-width: 32px;
display: flex;
align-items: center;
justify-content: center;
}
#toggleHudBtn:hover {
background: rgba(255, 209, 102, 0.25);
}

/* Map styling */
#mapContainer {
position: fixed; bottom: 20px; right: 20px; z-index: 9998;
background: var(--bg); backdrop-filter: blur(6px);
border: 1px solid rgba(255,255,255,.15);
border-radius: 12px; overflow: hidden; box-shadow: 0 6px 20px rgba(0,0,0,.25);
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
width: 200px; height: 200px;
}
#mapContainer.expanded {
width: 80vw; height: 80vh; bottom: 10%; right: 10%;
}
#map {
width: 100%; height: 100%;
}
#toggleMapBtn {
position: absolute; top: 8px; right: 8px;
background: rgba(255, 209, 102, 0.15);
color: var(--accent);
border: 1px solid rgba(255, 209, 102, 0.3);
font-weight: 600;
font-size: 14px;
min-width: 32px; min-height: 32px;
display: flex;
align-items: center;
justify-content: center;
border-radius: 8px; cursor: pointer;
z-index: 10000;
transition: all 0.2s ease;
pointer-events: auto;
}
#toggleMapBtn:hover {
background: rgba(255, 209, 102, 0.25);
}
  
#directionIndicator {
position: absolute; bottom: 8px; left: 8px;
background: rgba(0,0,0,.6); color: var(--accent);
padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;
pointer-events: none; z-index: 9999;
}

* { transition: transform 0.1s ease; }
</style>
</head>
<body>
<!-- Heads-up UI -->
<div id="hud">
<div class="card">
<div class="row header-compact">
<div class="title">Popular Study Spots on Campus</div>
<button id="toggleHudBtn" class="btn" title="Minimize/Maximize HUD">âˆ’</button>
</div>

<div class="minimizable">
<div class="row" style="margin-top:6px">
<div style="font-size:13px; line-height:1.4; color:var(--muted);">
Explore popular study spots around CU Boulder campus using augmented reality. Enable location and camera permissions, then look around to see study locations in the world around you. <b style="color:var(--fg);">Blue checkboxes</b> show/hide locations on screen. <b style="color:var(--fg);">Golden checkboxes</b> mark locations as found to track your progress. Use the map to navigate.
</div>
</div>
<div class="row" style="margin-top:8px">
<button id="recenterBtn" class="btn">Re-center</button>
</div>
<div class="row" style="margin-top:6px">
<label class="chk"><input type="checkbox" id="toggleNorlin" checked />Norlin Library</label>
<span id="dNorlin" class="pill">-- m</span>
<span id="hNorlin" style="font-size:11px; color:var(--muted);">8am - 12am</span>
<input type="checkbox" id="foundNorlin" class="found-check" title="Mark as found" style="accent-color:#ffd166; width:18px; height:18px; cursor:pointer;" />
<label class="chk"><input type="checkbox" id="toggleATLAS" checked />ATLAS / VAC</label>
<span id="dATLAS" class="pill">-- m</span>
<span id="hATLAS" style="font-size:11px; color:var(--muted);">7am - 11pm</span>
<input type="checkbox" id="foundATLAS" class="found-check" title="Mark as found" style="accent-color:#ffd166; width:18px; height:18px; cursor:pointer;" />
<label class="chk"><input type="checkbox" id="toggleVarsity" checked />Varsity Lake</label>
<span id="dVarsity" class="pill">-- m</span>
<span id="hVarsity" style="font-size:11px; color:var(--muted);">Always open</span>
<input type="checkbox" id="foundVarsity" class="found-check" title="Mark as found" style="accent-color:#ffd166; width:18px; height:18px; cursor:pointer;" />
<label class="chk"><input type="checkbox" id="toggleEngLib" checked />Engineering Library (Math)</label>
<span id="dEngLib" class="pill">-- m</span>
<span id="hEngLib" style="font-size:11px; color:var(--muted);">8am - 10pm</span>
<input type="checkbox" id="foundEngLib" class="found-check" title="Mark as found" style="accent-color:#ffd166; width:18px; height:18px; cursor:pointer;" />
<label class="chk"><input type="checkbox" id="toggleMusic" checked />Music Library (Imig)</label>
<span id="dMusic" class="pill">-- m</span>
<span id="hMusic" style="font-size:11px; color:var(--muted);">9am - 9pm</span>
<input type="checkbox" id="foundMusic" class="found-check" title="Mark as found" style="accent-color:#ffd166; width:18px; height:18px; cursor:pointer;" />
</div>
<div class="row" style="margin-top:6px">
<small id="gpsStatus">GPS: looking for signalâ€¦</small>
</div>
<div class="row" style="margin-top:4px">
<small class="note">Tip: Tap <kbd>Re-center</kbd> if labels don't face you.</small>
</div>
</div>
</div>
</div>

<!-- Map Container -->
<div id="mapContainer">
<div id="map"></div>
<button id="toggleMapBtn" title="Expand/Collapse Map">+</button>
<div id="directionIndicator">--</div>
</div>

<div id="toast" aria-live="polite"></div>
  
<!-- AR Scene -->
<a-scene
vr-mode-ui="enabled: false"
renderer="antialias: true; alpha: true; colorManagement: true; physicallyCorrectLights: true"
embedded
arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
style="width:100%; height:100%;"
>
<a-camera gps-new-camera="gpsMinDistance: 5;"></a-camera>

<!-- Norlin -->
<a-entity id="poi-norlin" gps-new-entity-place="latitude:40.0085; longitude:-105.27016">
<a-entity gltf-model="assets/Bookstack.glb" scale="7 7 7" rotation="0 180 0" spin-y="speed:3"></a-entity>
<a-text id="label-norlin" value="Norlin Library" look-at="[gps-new-camera]" position="0 12 0" color="black" scale="10 10 10"></a-text>
</a-entity>

<!-- ATLAS -->
<a-entity id="poi-atlas" gps-new-entity-place="latitude:40.00779; longitude:-105.26967">
<a-entity gltf-model="assets/VideogameController.glb" scale="0.5 0.5 0.5" rotation="90 -20 0" spin-y="speed:3"></a-entity>
<a-text id="label-atlas" value="ATLAS Building" look-at="[gps-new-camera]" position="0 12 0" color="black" scale="10 10 10"></a-text>
</a-entity>

<!-- Varsity Lake -->
<a-entity id="poi-varsity" gps-new-entity-place="latitude:40.00966; longitude:-105.27428">
<a-entity gltf-model="assets/Lake.glb" scale="5 5 5" rotation="0 0 0" spin-y="speed:3"></a-entity>
<a-text id="label-varsity" value="Varsity Lake" look-at="[gps-new-camera]" position="0 12 0" color="black" scale="10 10 10"></a-text>
</a-entity>

<!-- Engineering Library (Math Building) -->
<a-entity id="poi-englib" gps-new-entity-place="latitude:40.00752; longitude:-105.26597">
<a-entity gltf-model="assets/Rover.glb" scale="3 3 3" rotation="0 0 0" spin-y="speed:3"></a-entity>
<a-text id="label-englib" value="Engineering Library (Math Building)" look-at="[gps-new-camera]" position="0 12 0" color="black" scale="10 10 10"></a-text>
</a-entity>

<!-- Music Library (Imig Building) -->
<a-entity id="poi-music" gps-new-entity-place="latitude:40.00623; longitude:-105.27038">
<a-entity gltf-model="assets/Piano.glb" scale="3 3 3" rotation="0 0 0" spin-y="speed:3"></a-entity>
<a-text id="label-music" value="Music Library (Imig Building)" look-at="[gps-new-camera]" position="0 12 0" color="black" scale="10 10 10"></a-text>
</a-entity>
</a-scene>

<script>
function haversineMeters(lat1, lon1, lat2, lon2) {
const toRad = d => d * Math.PI / 180;
const R = 6371000;
const dLat = toRad(lat2 - lat1);
const dLon = toRad(lon2 - lon1);
const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
return R * c;
}

function getBearing(lat1, lon1, lat2, lon2) {
const toRad = d => d * Math.PI / 180;
const toDeg = r => r * 180 / Math.PI;
const dLon = toRad(lon2 - lon1);
const y = Math.sin(dLon) * Math.cos(toRad(lat2));
const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
const bearing = (toDeg(Math.atan2(y, x)) + 360) % 360;
return bearing;
}

function getCardinalDirection(bearing) {
const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
const index = Math.round(bearing / 22.5) % 16;
return directions[index];
}

const targets = {
norlin: {lat:40.0085, lon:-105.27016, el:null, labelEl:null, toggleEl:null, distEl:null, name:'Norlin Library', hours:'8am - 12am', found:false},
atlas:  {lat:40.00779, lon:-105.26967, el:null, labelEl:null, toggleEl:null, distEl:null, name:'ATLAS Building', hours:'7am - 11pm', found:false},
varsity:{lat:40.00966, lon:-105.27428, el:null, labelEl:null, toggleEl:null, distEl:null, name:'Varsity Lake', hours:'Always open', found:false},
englib: {lat:40.00752, lon:-105.26597, el:null, labelEl:null, toggleEl:null, distEl:null, name:'Engineering Library', hours:'8am - 10pm', found:false},
music:  {lat:40.00623, lon:-105.27038, el:null, labelEl:null, toggleEl:null, distEl:null, name:'Music Library', hours:'9am - 9pm', found:false}
};

// Bind
targets.norlin.el = document.querySelector('#poi-norlin');
targets.atlas.el = document.querySelector('#poi-atlas');
targets.varsity.el = document.querySelector('#poi-varsity');
targets.englib.el = document.querySelector('#poi-englib');
targets.music.el = document.querySelector('#poi-music');
targets.norlin.labelEl = document.querySelector('#label-norlin');
targets.atlas.labelEl = document.querySelector('#label-atlas');
targets.varsity.labelEl = document.querySelector('#label-varsity');
targets.englib.labelEl = document.querySelector('#label-englib');
targets.music.labelEl = document.querySelector('#label-music');
targets.norlin.toggleEl = document.querySelector('#toggleNorlin');
targets.atlas.toggleEl = document.querySelector('#toggleATLAS');
targets.varsity.toggleEl = document.querySelector('#toggleVarsity');
targets.englib.toggleEl = document.querySelector('#toggleEngLib');
targets.music.toggleEl = document.querySelector('#toggleMusic');
targets.norlin.distEl = document.querySelector('#dNorlin');
targets.atlas.distEl = document.querySelector('#dATLAS');
targets.varsity.distEl = document.querySelector('#dVarsity');
targets.englib.distEl = document.querySelector('#dEngLib');
targets.music.distEl = document.querySelector('#dMusic');

const gpsStatus = document.querySelector('#gpsStatus');
const recenterBtn = document.querySelector('#recenterBtn');
const toast = document.querySelector('#toast');
const hud = document.querySelector('#hud');
const toggleHudBtn = document.querySelector('#toggleHudBtn');
const mapContainer = document.querySelector('#mapContainer');
const toggleMapBtn = document.querySelector('#toggleMapBtn');
const directionIndicator = document.querySelector('#directionIndicator');

let isMinimized = false;
let mapExpanded = false;
let map, userMarker, targetMarkers = {};

toggleHudBtn.addEventListener('click',()=>{
isMinimized=!isMinimized;
hud.classList.toggle('minimized',isMinimized);
toggleHudBtn.textContent=isMinimized?'+':'âˆ’';
showToast(isMinimized?'HUD minimized - tap + to expand':'HUD expanded');
});

toggleMapBtn.addEventListener('click', () => {
mapExpanded = !mapExpanded;
mapContainer.classList.toggle('expanded', mapExpanded);
toggleMapBtn.textContent = mapExpanded ? 'âˆ’' : '+';
setTimeout(() => map.invalidateSize(), 300);
});

Object.keys(targets).forEach(key=>{
targets[key].toggleEl.addEventListener('change',(e)=>{
targets[key].el.setAttribute('visible',e.target.checked);
});

const foundCheckId = 'found' + key.charAt(0).toUpperCase() + key.slice(1);
const foundCheck = document.querySelector('#' + foundCheckId);
foundCheck.addEventListener('change', (e) => {
targets[key].found = e.target.checked;
const foundCount = Object.values(targets).filter(t => t.found).length;
showToast(`Found ${foundCount}/5 locations!`);
});
});

recenterBtn.addEventListener('click',()=>{
Object.values(targets).forEach(t=>{
const p=t.labelEl.getAttribute('position');
t.labelEl.setAttribute('position',{x:p.x,y:p.y+0.001,z:p.z});
setTimeout(()=>t.labelEl.setAttribute('position',p),0);
});
showToast("Re-centered labels");
});

function showToast(msg){
const div=document.createElement('div');
div.className='msg';
div.textContent=msg;
toast.appendChild(div);
setTimeout(()=>{
div.style.opacity='0';
div.style.transform='translateY(6px)';
setTimeout(()=>div.remove(),600);
},1500);
}

// Initialize map
setTimeout(() => {
map = L.map('map').setView([40.00852, -105.26916], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: 'Â© OpenStreetMap',
maxZoom: 19
}).addTo(map);

const targetColors = {
norlin: '#FF6B6B',
atlas: '#4ECDC4',
varsity: '#45B7D1',
englib: '#FFA07A',
music: '#98D8C8'
};

Object.keys(targets).forEach(key => {
const target = targets[key];
const color = targetColors[key];
const html = `<svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="${color}" stroke="white" stroke-width="2"/></svg>`;
const icon = L.divIcon({html, iconSize: [30, 30], className: 'custom-marker'});
targetMarkers[key] = L.marker([target.lat, target.lon], {icon}).addTo(map).bindPopup(target.name);
});

userMarker = L.marker([40.00852, -105.26916], {
icon: L.icon({url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iOCIgZmlsbD0iI0ZGRDY2NiIgc3Ryb2tlPSIjRkZGIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=', iconSize: [24, 24]})
}).addTo(map);
}, 100);

const gpsCam=document.querySelector('[gps-new-camera]');
gpsCam.addEventListener('gps-camera-update-position',(e)=>{
const {latitude,longitude,accuracy}=e.detail.position;
gpsStatus.textContent=`GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (Â±${Math.round(accuracy||0)} m)`;

if(map && userMarker) {
map.setView([latitude, longitude], 16);
userMarker.setLatLng([latitude, longitude]);

let nearest = null;
let minDist = Infinity;
for (const key of Object.keys(targets)) {
const d = haversineMeters(latitude, longitude, targets[key].lat, targets[key].lon);
if (d < minDist) {
minDist = d;
nearest = key;
}
}

if (nearest) {
const bearing = getBearing(latitude, longitude, targets[nearest].lat, targets[nearest].lon);
const direction = getCardinalDirection(bearing);
const distStr = minDist >= 1000 ? (minDist / 1000).toFixed(2) + ' km' : Math.round(minDist) + ' m';
directionIndicator.textContent = `Head ${direction} (${distStr})`;
}
}

for(const key of Object.keys(targets)){
const t=targets[key];
const d=haversineMeters(latitude,longitude,t.lat,t.lon);
const val=d>=1000?(d/1000).toFixed(2)+' km':Math.round(d)+' m';
t.distEl.textContent=val;

// Notification at 100 meters
if(d <= 100 && d > 0 && !t.found && !t.notified) {
t.notified = true;
showToast(`ðŸŽ¯ You're close to ${t.name}!`);
}
if(d > 100) {
t.notified = false;
}
}
});
</script>
</body>
</html>
