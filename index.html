<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CU Boulder AR Scavenger Hunt (Norlin + ATLAS + Varsity + Museum)</title>

  <!-- A-Frame and AR.js -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

  <script>
    AFRAME.registerComponent('spin-y', {
      schema: {speed: {type: 'number', default: 30}},
      tick: function (time, deltaTime) {
        this.el.object3D.rotation.y += (this.data.speed * deltaTime) / 1000;
      }
    });
  </script>

  <style>
    :root { --bg: rgba(0,0,0,.55); --fg: #fff; --accent: #ffd166; --muted:#d9d9d9; }
    html, body { margin:0; padding:0; height:100%; background:#000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #hud { position: fixed; inset: 0 0 auto 0; padding: 10px 12px; display:flex; gap:8px;
      align-items: flex-start; color: var(--fg); z-index: 9999; pointer-events: none; }
    #hud .card { pointer-events: auto; background: var(--bg); backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.15); border-radius: 12px; padding: 10px 12px;
      line-height: 1.25; box-shadow: 0 6px 20px rgba(0,0,0,.25); margin-top: 30px; }
    #hud .title { font-weight: 700; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.15); }
    .pill b { color: var(--accent); }
    #toast { position: fixed; inset: auto 0 20px 0; display:flex; justify-content:center; z-index:9999; }
    #toast .msg { background: var(--bg); color:var(--fg); border:1px solid rgba(255,255,255,.15); padding:10px 14px; border-radius: 12px; }
    .btn { pointer-events:auto; cursor:pointer; background: rgba(255,255,255,.1); color:#fff; border:1px solid rgba(255,255,255,.2); border-radius: 10px; padding: 6px 10px; }
  </style>
</head>
<body>
  <!-- HUD -->
  <div id="hud">
    <div class="card">
      <div class="row header-compact">
        <div class="title">CU Boulder AR Hunt</div>
        <button id="toggleHudBtn" class="btn">−</button>
      </div>
      <div class="minimizable">
        <div class="row" style="margin-top:6px">
          <div class="pill"><b>Steps:</b> Enable <b>Location</b> + <b>Camera</b></div>
          <button id="recenterBtn" class="btn">Re-center</button>
        </div>
        <div class="row" style="margin-top:6px">
          <label><input type="checkbox" id="toggleNorlin" checked />Norlin</label>
          <span id="dNorlin" class="pill">-- m</span>
          <label><input type="checkbox" id="toggleATLAS" checked />ATLAS</label>
          <span id="dATLAS" class="pill">-- m</span>
        </div>
        <div class="row" style="margin-top:6px">
          <label><input type="checkbox" id="toggleVarsity" checked />Varsity Lake</label>
          <span id="dVarsity" class="pill">-- m</span>
          <label><input type="checkbox" id="toggleMuseum" checked />Museum</label>
          <span id="dMuseum" class="pill">-- m</span>
        </div>
        <div class="row" style="margin-top:6px">
          <small id="gpsStatus">GPS: looking for signal…</small>
        </div>
        <div class="row" style="margin-top:4px">
          <small id="closestLocation" class="note">Closest: --</small>
        </div>
      </div>
    </div>
  </div>
  <div id="toast"></div>

  <!-- AR Scene -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="antialias: true; alpha: true;"
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
    style="width:100%; height:100%;"
  >
    <a-camera gps-new-camera="gpsMinDistance: 5;"></a-camera>

    <!-- Norlin -->
    <a-entity id="poi-norlin" gps-new-entity-place="latitude: 40.0085; longitude: -105.27016">
      <a-entity gltf-model="assets/Bookstack.glb" scale="7 7 7" rotation="0 180 0" spin-y="speed:5"></a-entity>
      <a-text id="label-norlin" value="Norlin Library" look-at="[gps-new-camera]" position="0 12 0" scale="10 10 10"></a-text>
    </a-entity>

    <!-- ATLAS -->
    <a-entity id="poi-atlas" gps-new-entity-place="latitude: 40.00779; longitude: -105.26967">
      <a-entity gltf-model="assets/VideogameController.glb" scale="0.5 0.5 0.5" rotation="90 -20 0" spin-y="speed:5"></a-entity>
      <a-text id="label-atlas" value="ATLAS Building" look-at="[gps-new-camera]" position="0 12 0" scale="10 10 10"></a-text>
    </a-entity>

    <!-- Varsity Lake -->
    <a-entity id="poi-varsity" gps-new-entity-place="latitude:40.00966; longitude:-105.27428">
      <a-entity gltf-model="assets/Lake.glb" scale="5 5 5" rotation="0 0 0" spin-y="speed:5"></a-entity>
      <a-text id="label-varsity" value="Varsity Lake" look-at="[gps-new-camera]" position="0 12 0" scale="10 10 10"></a-text>
    </a-entity>

    <!-- Museum -->
    <a-entity id="poi-museum" gps-new-entity-place="latitude:40.00682; longitude:-105.27277">
      <a-entity gltf-model="assets/Bone.glb" scale="3 3 3" rotation="0 0 0" spin-y="speed:5"></a-entity>
      <a-text id="label-museum" value="Natural History Museum" look-at="[gps-new-camera]" position="0 12 0" scale="10 10 10"></a-text>
    </a-entity>
  </a-scene>

  <script>
    function haversineMeters(lat1, lon1, lat2, lon2) {
      const toRad = d => d * Math.PI / 180, R = 6371000;
      const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    const targets = {
      norlin: { name:"Norlin Library", lat:40.008351, lon:-105.269859, el:'#poi-norlin', toggle:'#toggleNorlin', dist:'#dNorlin', label:'#label-norlin' },
      atlas: { name:"ATLAS / VAC", lat:40.0071202988, lon:-105.2697575751, el:'#poi-atlas', toggle:'#toggleATLAS', dist:'#dATLAS', label:'#label-atlas' },
      varsity: { name:"Varsity Lake", lat:40.00966, lon:-105.27428, el:'#poi-varsity', toggle:'#toggleVarsity', dist:'#dVarsity', label:'#label-varsity' },
      museum: { name:"Natural History Museum", lat:40.00682, lon:-105.27277, el:'#poi-museum', toggle:'#toggleMuseum', dist:'#dMuseum', label:'#label-museum' },
    };

    for (const k in targets) {
      const t = targets[k];
      t.el = document.querySelector(t.el);
      t.toggleEl = document.querySelector(t.toggle);
      t.distEl = document.querySelector(t.dist);
      t.labelEl = document.querySelector(t.label);
      t.toggleEl.addEventListener('change', e => t.el.setAttribute('visible', e.target.checked));
    }

    const gpsStatus = document.querySelector('#gpsStatus');
    const closestEl = document.querySelector('#closestLocation');

    const gpsCam = document.querySelector('[gps-new-camera]');
    gpsCam.addEventListener('gps-camera-update-position', e => {
      const {latitude, longitude, accuracy} = e.detail.position;
      gpsStatus.textContent = `GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (±${Math.round(accuracy||0)} m)`;

      let minDist = Infinity, closestName = "--";
      for (const k in targets) {
        const t = targets[k];
        const d = haversineMeters(latitude, longitude, t.lat, t.lon);
        t.distEl.textContent = d >= 1000 ? (d/1000).toFixed(2)+" km" : Math.round(d)+" m";
        if (d < minDist) { minDist = d; closestName = t.name; }
      }
      closestEl.textContent = "Closest: " + closestName;
    });
  </script>
</body>
</html>
